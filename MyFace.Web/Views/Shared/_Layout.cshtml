@using Microsoft.AspNetCore.Html
@inject MyFace.Services.MailService MailService
@inject MyFace.Services.OnionStatusService OnionService
@{
    var unreadCount = 0;
    if (User.Identity?.IsAuthenticated == true)
    {
        var idClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(idClaim, out var uid))
        {
            unreadCount = await MailService.GetUnreadCountAsync(uid);
        }
    }
    var topOnions = await OnionService.GetTopByClicksAsync(4);
    Func<IHtmlContent> MailBadge = () => unreadCount > 0
        ? new HtmlString("<span style=\"color:#e11d48; font-weight:700; margin-left:2px; position:relative; top:-1px;\">!" + "</span>")
        : HtmlString.Empty;
    var isChatPage = string.Equals(ViewContext.RouteData.Values["controller"]?.ToString(), "Chat", StringComparison.OrdinalIgnoreCase);
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>@ViewData["Title"] - Sigil</title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="@(isChatPage ? "chat-page-body" : string.Empty)">
    <header>
        <nav class="nav-bar">
            <div class="container">
                <a href="@Url.Action("Index", "Thread")" class="logo">Sigil</a>
                <ul class="nav-menu">
                    <li><a href="@Url.Action("Index", "Thread")">Threads</a></li>
                    <li><a href="@Url.Action("Index", "Monitor")">Monitor</a></li>
                    <li><a href="@Url.Action("Index", "Chat")">Chat</a></li>
                    <li><a href="@Url.Action("Index", "Mail")">Mail @MailBadge()</a></li>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        @if (User.IsInRole("Admin"))
                        {
                            <li><a href="@Url.Action("Index", "Admin")">Admin</a></li>
                        }
                        @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                        {
                            <li><a href="@Url.Action("Index", "Moderator")">Mod</a></li>
                        }
                        <li><a href="@Url.Action("Index", "User", new { username = User.Identity.Name })">My Profile</a></li>
                        <li><a href="@Url.Action("Logout", "Account")">Logout</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Login", "Account")">Login</a></li>
                        <li><a href="@Url.Action("Register", "Account")">Register</a></li>
                    }
                </ul>
            </div>
        </nav>
    </header>
    <div class="main-wrapper @(isChatPage ? "chat-page-layout" : string.Empty)">
        @if (!isChatPage)
        {
            <aside class="sidebar sidebar-left">
                <nav class="sidebar-nav">
                    <h3>Navigation</h3>
                    <ul>
                        <li><a href="@Url.Action("Index", "Thread")">Threads</a></li>
                        <li><a href="@Url.Action("Index", "Monitor")">Monitor</a></li>
                        <li><a href="@Url.Action("Index", "Chat")">Chat</a></li>
                        <li><a href="@Url.Action("Index", "Mail")">Mail @MailBadge()</a></li>
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            @if (User.IsInRole("Admin"))
                            {
                                <li><a href="@Url.Action("Index", "Admin")">Admin Panel</a></li>
                            }
                            @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                            {
                                <li><a href="@Url.Action("Index", "Moderator")">Moderation</a></li>
                            }
                            <li><a href="@Url.Action("Index", "User", new { username = User.Identity.Name })">My Profile</a></li>
                        }
                        else
                        {
                            <li><a href="@Url.Action("Login", "Account")">Login</a></li>
                            <li><a href="@Url.Action("Register", "Account")">Register</a></li>
                        }
                    </ul>
                </nav>
            </aside>
        }
        <div class="container main-content @(isChatPage ? "chat-content-expanded" : string.Empty)">
            <main>
                @RenderBody()
            </main>
        </div>
        @if (!isChatPage)
        {
            <aside class="sidebar sidebar-right">
                <p class="onion-title">Top Onion Links</p>
                <div class="onion-cards">
                    @foreach (var link in topOnions)
                    {
                        var statusClass = link.Status?.Equals("Online", StringComparison.OrdinalIgnoreCase) == true
                            ? "status-online"
                            : link.Status?.Equals("DEGRADED", StringComparison.OrdinalIgnoreCase) == true
                                ? "status-degraded"
                                : "status-offline";

                        <a href="@Url.Action("Go", "Monitor", new { id = link.Id })" class="onion-card">
                            <div class="onion-card__header">
                                <div>
                                    <span class="onion-name">@link.Name</span>
                                    <span class="onion-url">@link.OnionUrl</span>
                                </div>
                                <span class="status-dot @statusClass" title="@link.Status"></span>
                            </div>
                            <div class="onion-card__meta">
                                <span class="onion-clicks">Clicks: @link.ClickCount</span>
                                <span class="onion-status-label">@link.Status</span>
                            </div>
                        </a>
                    }
                </div>
            </aside>
        }
    </div>
    <footer>
        <div class="container"></div>
    </footer>
    @RenderSection("Scripts", required: false)
</body>
</html>
