@using Microsoft.AspNetCore.Html
@inject MyFace.Services.MailService MailService
@inject MyFace.Services.OnionStatusService OnionService
@{
    var unreadCount = 0;
    if (User.Identity?.IsAuthenticated == true)
    {
        var idClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(idClaim, out var uid))
        {
            unreadCount = await MailService.GetUnreadCountAsync(uid);
        }
    }
    var topOnions = await OnionService.GetTopByClicksAsync(4);
    Func<IHtmlContent> MailBadge = () => unreadCount > 0
        ? new HtmlString("<span style=\"color:#e11d48; font-weight:700; margin-left:2px; position:relative; top:-1px;\">!" + "</span>")
        : HtmlString.Empty;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>@ViewData["Title"] - Sigil</title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="alternate" type="application/rss+xml" title="Latest Threads" href="@Url.Action("Threads", "Rss")" />
</head>
<body>
    <header>
        <nav class="nav-bar">
            <div class="container">
                <a href="@Url.Action("Index", "Thread")" class="logo">Sigil</a>
                <ul class="nav-menu">
                    <li><a href="@Url.Action("Index", "Thread")">Threads</a></li>
                    <li><a href="@Url.Action("Index", "Monitor")">Monitor</a></li>
                    <li><a href="@Url.Action("Index", "Chat")">Chat</a></li>
                    <li><a href="@Url.Action("Index", "Mail")">Mail @MailBadge()</a></li>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        @if (User.IsInRole("Admin"))
                        {
                            <li><a href="@Url.Action("Index", "Admin")">Admin</a></li>
                        }
                        @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                        {
                            <li><a href="@Url.Action("Index", "Moderator")">Mod</a></li>
                        }
                        <li><a href="@Url.Action("Index", "User", new { username = User.Identity.Name })">My Profile</a></li>
                        <li><a href="@Url.Action("Logout", "Account")">Logout</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Login", "Account")">Login</a></li>
                        <li><a href="@Url.Action("Register", "Account")">Register</a></li>
                    }
                </ul>
            </div>
        </nav>
    </header>
    <div class="main-wrapper">
        <aside class="sidebar sidebar-left">
            <nav class="sidebar-nav">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="@Url.Action("Index", "Thread")">Threads</a></li>
                    <li><a href="@Url.Action("Index", "Monitor")">Monitor</a></li>
                    <li><a href="@Url.Action("Index", "Chat")">Chat</a></li>
                    <li><a href="@Url.Action("Index", "Mail")">Mail @MailBadge()</a></li>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        @if (User.IsInRole("Admin"))
                        {
                            <li><a href="@Url.Action("Index", "Admin")">Admin Panel</a></li>
                        }
                        @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                        {
                            <li><a href="@Url.Action("Index", "Moderator")">Moderation</a></li>
                        }
                        <li><a href="@Url.Action("Index", "User", new { username = User.Identity.Name })">My Profile</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Login", "Account")">Login</a></li>
                        <li><a href="@Url.Action("Register", "Account")">Register</a></li>
                    }
                </ul>
            </nav>
        </aside>
        <div class="container main-content">
            <main>
                @RenderBody()
            </main>
        </div>
        <aside class="sidebar sidebar-right">
            <p class="onion-title">Top Onion Links</p>
            <div class="onion-cards">
                @foreach (var link in topOnions)
                {
                    var statusClass = link.Status?.Equals("Online", StringComparison.OrdinalIgnoreCase) == true
                        ? "status-online"
                        : link.Status?.Equals("DEGRADED", StringComparison.OrdinalIgnoreCase) == true
                            ? "status-degraded"
                            : "status-offline";

                    <a href="@Url.Action("Go", "Monitor", new { id = link.Id })" class="onion-card">
                        <div class="onion-card__header">
                            <div>
                                <span class="onion-name">@link.Name</span>
                                <span class="onion-url">@link.OnionUrl</span>
                            </div>
                            <span class="status-dot @statusClass" title="@link.Status"></span>
                        </div>
                        <div class="onion-card__meta">
                            <span class="onion-clicks">Clicks: @link.ClickCount</span>
                            <span class="onion-status-label">@link.Status</span>
                        </div>
                    </a>
                }
            </div>
        </aside>
    </div>
    <footer>
        <div class="container">
            <p>Sigil - Privacy-focused forum | <a href="@Url.Action("Threads", "Rss")">RSS</a> | No JavaScript | No tracking</p>
            @if (User.Identity?.IsAuthenticated == true)
            {
                <p style="font-size: 0.8em; color: #666;">
                    Debug: Role Claim = @User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value <br/>
                    IsAdmin = @User.IsInRole("Admin")
                </p>
            }
        </div>
    </footer>
</body>
</html>
