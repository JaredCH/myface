@model MyFace.Web.Models.ModeratorDashboardViewModel
@using Microsoft.Extensions.Configuration
@using System.Security.Claims
@using System.Linq
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "UserControl - Moderation Panel";
    var username = User.Identity?.Name;
    var viewerRole = User.FindFirstValue(ClaimTypes.Role);
    var viewerIsAdmin = string.Equals(viewerRole, "Admin", StringComparison.OrdinalIgnoreCase);
    var viewerIsMod = string.Equals(viewerRole, "Moderator", StringComparison.OrdinalIgnoreCase);
    var isAdminOrMod = viewerIsAdmin || viewerIsMod;
}

<h1>User Control Panel</h1>

<section class="panel-section">
    <h2>üîí User Management</h2>
    <p>Manage user suspensions and access control</p>

    @if (TempData["Success"] != null)
    {
        <div class="alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert-error">@TempData["Error"]</div>
    }

    <div class="mod-filters mb-3">
        <form method="get" style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:flex-end;">
            <div>
                <label for="search">Search Username:</label>
                <input id="search" name="search" placeholder="Username..." class="input" value="@(Model.SearchQuery ?? "")" />
            </div>
            <div>
                <label for="sortBy">Sort By:</label>
                <select id="sortBy" name="sortBy" class="input">
                    <option value="username" selected="@(Model.SortBy == "username")">Username (A-Z)</option>
                    <option value="date-desc" selected="@(Model.SortBy == "date-desc")">Newest First</option>
                    <option value="date-asc" selected="@(Model.SortBy == "date-asc")">Oldest First</option>
                </select>
            </div>
            <button type="submit" class="button">Search</button>
            <a href="@Url.Action("Index")" class="button">Clear</a>
        </form>
    </div>

    <div class="mod-user-list">
        @foreach (var user in Model.Users)
        {
            var isSelf = string.Equals(user.Username, username, StringComparison.OrdinalIgnoreCase);
            var canSuspend = !isSelf && (viewerIsAdmin || user.Role == "User");
            var isSuspended = user.SuspendedUntil.HasValue && user.SuspendedUntil.Value > DateTime.UtcNow;
            var statusClass = isSuspended ? "mod-user-status mod-user-status--active" : user.SuspendedUntil.HasValue ? "mod-user-status mod-user-status--expired" : "mod-user-status";
            var statusCopy = isSuspended
                ? $"Suspended until {user.SuspendedUntil!.Value:g}"
                : user.SuspendedUntil.HasValue
                    ? $"Suspension expired {user.SuspendedUntil!.Value:g}"
                    : "No restrictions";
            var roleClass = (user.Role ?? "user").ToLowerInvariant();

            <article class="mod-user-card @(isSuspended ? "mod-user-card--suspended" : string.Empty)">
                <div class="mod-user-line">
                    <div class="mod-user-meta">
                        <a class="mod-user-name" href="@Url.Action("ViewProfile", "ProfileDisplay", new { username = user.Username })">@user.Username</a>
                        <span class="role-badge role-@roleClass">@user.Role</span>
                        <span class="text-muted" style="font-size:0.85em;">Joined: @user.CreatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div class="@statusClass">@statusCopy</div>
                </div>
                <div class="mod-user-actions">
                    @if (canSuspend)
                    {
                        <form asp-action="SuspendUser" method="post" class="mod-inline-form">
                            <input type="hidden" name="userId" value="@user.Id" />
                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                            <input type="hidden" name="search" value="@Model.SearchQuery" />
                            <input type="hidden" name="sortBy" value="@Model.SortBy" />
                            <select name="duration" class="mod-select" aria-label="Suspension duration">
                                <option value="24h">Mute 24h</option>
                                <option value="72h">Mute 72h</option>
                                <option value="1w">Suspend 1w</option>
                                <option value="2w">Suspend 2w</option>
                                <option value="1m">Suspend 1m</option>
                                <option value="forever">Ban Forever</option>
                                <option value="unsuspend">Unmute/Unsuspend</option>
                            </select>
                            <button type="submit" class="mod-action-btn">Apply</button>
                            @Html.AntiForgeryToken()
                        </form>
                        <a href="@Url.Action("ManageUser", "ControlPanel", new { userId = user.Id })" class="button button-sm">View Details</a>
                    }
                    else
                    {
                        <span class="text-muted mod-user-note">@(isSelf ? "Cannot modify self" : "Protected account")</span>
                    }
                </div>
            </article>
        }
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="pagination" style="margin-top:1rem;display:flex;gap:0.5rem;justify-content:center;">
            @if (Model.CurrentPage > 1)
            {
                <a href="@Url.Action("Index", new { page = Model.CurrentPage - 1, search = Model.SearchQuery, sortBy = Model.SortBy })" class="button">‚Üê Previous</a>
            }
            <span class="pagination-info">Page @Model.CurrentPage of @Model.TotalPages</span>
            @if (Model.CurrentPage < Model.TotalPages)
            {
                <a href="@Url.Action("Index", new { page = Model.CurrentPage + 1, search = Model.SearchQuery, sortBy = Model.SortBy })" class="button">Next ‚Üí</a>
            }
        </div>
    }
</section>
