@model List<MyFace.Core.Entities.Post>
@inject MyFace.Web.Services.BBCodeFormatter Formatter
@{
    var user = (MyFace.Core.Entities.User)ViewBag.User;
    ViewData["Title"] = user.Username;
    var currentPage = (int)ViewBag.CurrentPage;
    var hasMore = (bool)ViewBag.HasMorePages;
    var isSelf = (bool)(ViewBag.IsOwner ?? false);
    var isAdminOrMod = (bool)(ViewBag.IsAdminOrMod ?? false);
    var isAdmin = (bool)(ViewBag.IsAdmin ?? false);
}

<div style="color: @user.FontColor; font-family: @user.FontFamily">
    <h1 style="display: inline-flex; align-items: center; gap: 0.5rem;">
        @user.Username
        @if (user.PGPVerifications?.Any(v => v.Verified) == true)
        {
            <span style="color: #10b981; font-size: 1.5rem;" title="PGP Verified">‚úì</span>
        }
    </h1>
    <p class="meta">Joined @user.CreatedAt.ToString("u")</p>

    @if (isSelf)
    {
        <p><a href="/user/edit" class="button">Edit Profile</a></p>
    }

    @if (isAdminOrMod)
    {
        <div style="background: #1e293b; border: 1px solid #334155; padding: 1rem; margin-bottom: 1rem; border-radius: 6px;">
            <div style="color: #94a3b8; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>‚öôÔ∏è Moderation Tools</span>
            </div>
            
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label style="display: block; color: #94a3b8; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.4rem;">Edit About Me</label>
                    <form asp-action="AdminEditAboutMe" method="post" style="display: flex; gap: 0.5rem;">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <input name="aboutMe" value="@user.AboutMe" placeholder="About me text..." style="flex: 1; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; font-size: 0.85rem; background: #0f172a; color: #e2e8f0;" />
                        <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer; white-space: nowrap;">‚úèÔ∏è Save</button>
                    </form>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; color: #94a3b8; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.4rem;">Suspend User</label>
                        <form asp-action="SuspendUser" method="post" style="display: flex; gap: 0.5rem;">
                            <input type="hidden" name="userId" value="@user.Id" />
                            <select name="duration" style="flex: 1; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; font-size: 0.85rem; background: #0f172a; color: #e2e8f0;">
                                <option value="24h">24 Hours</option>
                                <option value="72h">3 Days</option>
                                <option value="1w">1 Week</option>
                                <option value="2w">2 Weeks</option>
                                <option value="1m">1 Month</option>
                                <option value="forever">Forever</option>
                                <option value="unsuspend">Unsuspend</option>
                            </select>
                            <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">‚è∏Ô∏è Apply</button>
                        </form>
                    </div>
                    
                    @if (isAdmin)
                    {
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; color: #fca5a5; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.4rem;">Delete Account</label>
                            <form asp-action="DeleteAccount" method="post">
                                <input type="hidden" name="userId" value="@user.Id" />
                                <button type="submit" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer; width: 100%;">üóëÔ∏è Delete Account</button>
                            </form>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="card">
        <h3>About Me</h3>
        <div>@Formatter.Format(user.AboutMe)</div>
    </div>

    <div class="card">
        <h3>Contact Info</h3>
        <ul>
            @foreach (var contact in user.Contacts)
            {
                <li>
                    <strong>@contact.ServiceName</strong>: @contact.AccountId
                    @if (isSelf)
                    {
                        <form asp-action="RemoveContact" method="post" style="display:inline">
                            <input type="hidden" name="id" value="@contact.Id" />
                            <button type="submit" class="button" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Remove</button>
                        </form>
                    }
                </li>
            }
        </ul>
        @if (isSelf)
        {
            <h4>Add Contact</h4>
            <form asp-action="AddContact" method="post">
                <input name="ServiceName" placeholder="Service (e.g. XMPP)" class="input" style="width: 30%" />
                <input name="AccountId" placeholder="Account ID" class="input" style="width: 40%" />
                <button type="submit" class="button">Add</button>
            </form>
        }
    </div>

    <div class="card">
        <h3>News Feed</h3>
        @foreach (var news in user.News.OrderByDescending(n => n.CreatedAt))
        {
            <div style="border-bottom: 1px solid #333; padding-bottom: 1rem; margin-bottom: 1rem;">
                <h4><a href="/user/news/@news.Id">@news.Title</a> <span class="meta" style="font-size: 0.8rem">@news.CreatedAt.ToString("g")</span></h4>
                <div style="max-height: 200px; overflow: hidden; position: relative;">
                    @Formatter.Format(news.Content)
                </div>
                <p><a href="/user/news/@news.Id" style="font-size: 0.9rem;">Read more / Permalink</a></p>
                @if (isSelf)
                {
                    <form asp-action="RemoveNews" method="post" style="display:inline">
                        <input type="hidden" name="id" value="@news.Id" />
                        <button type="submit" class="button" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Delete</button>
                    </form>
                }
            </div>
        }
        @if (isSelf)
        {
            <h4>Post News</h4>
            <form asp-action="AddNews" method="post">
                <input name="Title" placeholder="Title" class="input" style="margin-bottom: 0.5rem" />
                <textarea name="Content" placeholder="Content (BBCode supported)" class="input" rows="3"></textarea>
                <button type="submit" class="button">Post</button>
            </form>
        }
    </div>

    <div class="card">
        <h3>üîê PGP Public Key</h3>
        @if (!string.IsNullOrWhiteSpace(user.PgpPublicKey))
        {
            @if (user.PGPVerifications?.Any(v => v.Verified) == true)
            {
                <p style="color: #10b981; font-weight: 600; margin-bottom: 0.5rem;">‚úì Verified</p>
            }
            else
            {
                <p style="color: #f59e0b; font-weight: 600; margin-bottom: 0.5rem;">‚ö† Not Verified</p>
            }
            <pre style="white-space: pre-wrap; font-size: 0.7rem; max-height: 100px; overflow: auto; padding: 0.5rem; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0;">@user.PgpPublicKey</pre>
        }
        else
        {
            <p class="meta">No PGP key configured</p>
        }
        
        @if (isSelf)
        {
            <div style="margin-top: 1rem;">
                <a href="/account/pgpsetup" class="button" style="background: #3b82f6;">üîë Setup/Update PGP Key</a>
            </div>
        }
    </div>

    <h3>Recent Posts</h3>
    @foreach (var post in Model)
    {
        <div class="card">
            <div>@Formatter.Format(post.Content)</div>
            <p class="meta">@post.CreatedAt.ToString("u") in <a href="@Url.Action("View","Thread", new { id = post.ThreadId })">@post.Thread.Title</a></p>
            <p><a class="button" href="@Url.Action("View","Thread", new { id = post.ThreadId })#reply">Reply in thread</a></p>
        </div>
    }

    <div class="form-actions">
        @if (currentPage > 1)
        {
            <a class="button" href="@Url.Action("Index", new { username = user.Username, page = currentPage - 1 })">Previous</a>
        }
        @if (hasMore)
        {
            <a class="button" href="@Url.Action("Index", new { username = user.Username, page = currentPage + 1 })">Next</a>
        }
        <span class="meta"> Page @currentPage </span>
    </div>
</div>
