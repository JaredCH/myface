@model List<MyFace.Core.Entities.Post>
@using System
@inject MyFace.Web.Services.BBCodeFormatter Formatter
@{
    string AdjustColor(string hex, double factor)
    {
        if (string.IsNullOrWhiteSpace(hex) || !hex.StartsWith("#") || (hex.Length != 7 && hex.Length != 4)) return hex ?? string.Empty;
        string Expand(string h) => h.Length == 4 ? $"#{h[1]}{h[1]}{h[2]}{h[2]}{h[3]}{h[3]}" : h;
        var full = Expand(hex);
        try
        {
            int r = Convert.ToInt32(full.Substring(1, 2), 16);
            int g = Convert.ToInt32(full.Substring(3, 2), 16);
            int b = Convert.ToInt32(full.Substring(5, 2), 16);
            r = Math.Clamp((int)(r * factor), 0, 255);
            g = Math.Clamp((int)(g * factor), 0, 255);
            b = Math.Clamp((int)(b * factor), 0, 255);
            return $"#{r:X2}{g:X2}{b:X2}";
        }
        catch { return hex; }
    }

    var user = (MyFace.Core.Entities.User)ViewBag.User;
    ViewData["Title"] = user.Username;
    var currentPage = (int)ViewBag.CurrentPage;
    var hasMore = (bool)ViewBag.HasMorePages;
    var isSelf = (bool)(ViewBag.IsOwner ?? false);
    var isAdminOrMod = (bool)(ViewBag.IsAdminOrMod ?? false);
    var isAdmin = (bool)(ViewBag.IsAdmin ?? false);
    
    // Provide defaults for theme properties
    var bgColor = string.IsNullOrWhiteSpace(user.BackgroundColor) ? "#f6f7fb" : user.BackgroundColor;
    var fontColor = string.IsNullOrWhiteSpace(user.FontColor) ? "#1f2933" : user.FontColor;
    var fontFamily = string.IsNullOrWhiteSpace(user.FontFamily) ? "system-ui, -apple-system, sans-serif" : user.FontFamily;
    var fontSize = 14; // fixed page-wide size; use BBCode for per-text sizing
    var accentColor = string.IsNullOrWhiteSpace(user.AccentColor) ? "#2f6fe4" : user.AccentColor;
    var borderColor = string.IsNullOrWhiteSpace(user.BorderColor) ? "#d9dee7" : user.BorderColor;

    // Button theming (with derived hover/active)
    var btnBg = string.IsNullOrWhiteSpace(user.ButtonBackgroundColor) ? accentColor : user.ButtonBackgroundColor;
    var btnText = string.IsNullOrWhiteSpace(user.ButtonTextColor) ? "#ffffff" : user.ButtonTextColor;
    var btnBorder = string.IsNullOrWhiteSpace(user.ButtonBorderColor) ? btnBg : user.ButtonBorderColor;
    var btnHover = AdjustColor(btnBg, 0.9);
    var btnActive = AdjustColor(btnBg, 0.8);

    // Site defaults for recent posts (not themed)
    var defaultRecentBg = "#ffffff";
    var defaultRecentBorder = "#d9dee7";
    var defaultRecentText = "#1f2933";
    var defaultRecentAccent = accentColor;
}

<style>
    .theme-button { background: @btnBg; color: @btnText; border: 1px solid @btnBorder; padding: 0.5rem 0.9rem; border-radius: 6px; font-weight: 700; letter-spacing: 0.01em; box-shadow: 0 6px 18px rgba(0,0,0,0.15); transition: transform 120ms ease, background 120ms ease, box-shadow 120ms ease; text-decoration: none; display: inline-block; }
    .theme-button:hover { background: @btnHover; transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,0.2); }
    .theme-button:active { background: @btnActive; transform: translateY(0); box-shadow: 0 4px 12px rgba(0,0,0,0.18); }
    .theme-button.ghost { background: transparent; color: @btnBg; border-color: @btnBorder; box-shadow: none; }
</style>

<div style="background-color: @bgColor; color: @fontColor; font-family: @fontFamily; font-size: @(fontSize)px; padding: 2rem; min-height: 100vh;">
    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div>
                <h1 style="display: inline-flex; align-items: center; gap: 0.5rem; margin: 0 0 0.5rem 0;">
                    @user.Username
                    @if (user.PGPVerifications?.Any(v => v.Verified) == true)
                    {
                        <span style="color: #10b981; font-size: 1.5rem;" title="PGP Verified">‚úì</span>
                    }
                </h1>
                <p class="meta" style="color: @fontColor; opacity: 0.7; margin: 0;">Joined @user.CreatedAt.ToString("MMMM yyyy")</p>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.4rem; flex-wrap: wrap;">
                    <a href="@Url.Action("Activity", "User", new { username = user.Username })" class="theme-button ghost">üîç Recent Activity</a>
                </div>
                
                @if (isSelf)
                {
                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <a href="/user/editprofile" class="theme-button">üé® Customize Page</a>
                        <a href="/user/edit" class="theme-button ghost">üìù Quick Edit</a>
                        <a href="/user/news/new" class="theme-button ghost">üì∞ Post news</a>
                    </div>
                }
                else if (User.Identity?.IsAuthenticated == true)
                {
                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <a href="@Url.Action("Index", "Mail", new { tab = "new", to = user.Username })" class="theme-button">‚úâÔ∏è Message</a>
                    </div>
                }
                else if (isAdminOrMod)
                {
                    <div style="margin-top: 0.75rem; display: flex; gap: 0.4rem; flex-wrap: wrap; align-items: center;">
                        <details style="font-size: 0.9rem; color: #475569; background: rgba(148,163,184,0.12); border: 1px solid rgba(148,163,184,0.45); border-radius: 6px; padding: 0.35rem 0.55rem;">
                            <summary style="cursor: pointer; list-style: none; display: inline-flex; align-items: center; gap: 0.35rem; font-weight: 700; color: #0f172a;">
                                üõ†Ô∏è Admin tools
                            </summary>
                            <div style="display: grid; gap: 0.45rem; margin-top: 0.4rem;">
                                <form asp-action="SuspendUser" method="post" style="display: flex; gap: 0.35rem; align-items: center;">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <select name="duration" style="padding: 0.25rem 0.35rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem;">
                                        <option value="24h">24h</option>
                                        <option value="72h">3d</option>
                                        <option value="1w">1w</option>
                                        <option value="2w">2w</option>
                                        <option value="1m">1m</option>
                                        <option value="forever">Forever</option>
                                        <option value="unsuspend">Unsuspend</option>
                                    </select>
                                    <button type="submit" class="button" style="padding: 0.35rem 0.6rem; font-size: 0.85rem;">‚è∏Ô∏è Apply</button>
                                </form>
                                @if (isAdmin)
                                {
                                    <form asp-action="DeleteAccount" method="post" style="display: flex; gap: 0.35rem; align-items: center;">
                                        <input type="hidden" name="userId" value="@user.Id" />
                                        <button type="submit" class="button" style="padding: 0.35rem 0.6rem; font-size: 0.85rem; background: #dc2626; color: #fff; border-color: #dc2626;">üóëÔ∏è Delete Account</button>
                                    </form>
                                }
                            </div>
                        </details>
                    </div>
                }
            </div>
            
            <!-- Trophy Display for Votes -->
            <div style="display: flex; gap: 0.6rem; flex-wrap: wrap;">
                <div style="text-align: center; min-width: 80px; background: rgba(47,111,228,0.12); border: 1px solid rgba(47,111,228,0.35); border-radius: 10px; padding: 0.6rem 0.75rem;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.1rem; line-height: 1;">üèÜ</div>
                    <div style="font-size: 1.3rem; font-weight: 800; color: @accentColor; line-height: 1;">@user.PostUpvotes</div>
                    <div style="font-size: 0.8rem; font-weight: 700; color: @fontColor; opacity: 0.95; line-height: 1;">Thread ‚Üë</div>
                </div>
                <div style="text-align: center; min-width: 80px; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35); border-radius: 10px; padding: 0.6rem 0.75rem;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.1rem; line-height: 1;">‚ö°</div>
                    <div style="font-size: 1.3rem; font-weight: 800; color: #d92c2c; line-height: 1;">@user.PostDownvotes</div>
                    <div style="font-size: 0.8rem; font-weight: 700; color: @fontColor; opacity: 0.95; line-height: 1;">Thread ‚Üì</div>
                </div>
                <div style="text-align: center; min-width: 80px; background: rgba(47,111,228,0.12); border: 1px solid rgba(47,111,228,0.35); border-radius: 10px; padding: 0.6rem 0.75rem;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.1rem; line-height: 1;">üí¨</div>
                    <div style="font-size: 1.3rem; font-weight: 800; color: @accentColor; line-height: 1;">@user.CommentUpvotes</div>
                    <div style="font-size: 0.8rem; font-weight: 700; color: @fontColor; opacity: 0.95; line-height: 1;">Comment ‚Üë</div>
                </div>
                <div style="text-align: center; min-width: 80px; background: rgba(249,115,22,0.12); border: 1px solid rgba(249,115,22,0.35); border-radius: 10px; padding: 0.6rem 0.75rem;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.1rem; line-height: 1;">üí≠</div>
                    <div style="font-size: 1.3rem; font-weight: 800; color: #d6580a; line-height: 1;">@user.CommentDownvotes</div>
                    <div style="font-size: 0.8rem; font-weight: 700; color: @fontColor; opacity: 0.95; line-height: 1;">Comment ‚Üì</div>
                </div>
            </div>
        </div>

    <div style="background: @bgColor; border: 1px solid @borderColor; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
        <h3 style="color: @accentColor; margin-top: 0; display: inline-flex; align-items: center; gap: 0.4rem;">About Me
            @if (isAdminOrMod && !isSelf)
            {
                <details style="font-size: 0.85rem; color: #475569;">
                    <summary style="cursor: pointer; list-style: none;">‚úèÔ∏è</summary>
                    <form asp-action="AdminEditAboutMe" method="post" style="margin-top: 0.4rem; display: grid; gap: 0.35rem;">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <textarea name="aboutMe" rows="3" style="padding: 0.35rem; border: 1px solid @borderColor; border-radius: 6px; font-size: 0.9rem;">@user.AboutMe</textarea>
                        <button type="submit" class="button" style="width: fit-content; padding: 0.3rem 0.6rem; font-size: 0.85rem;">üíæ Save</button>
                    </form>
                </details>
            }
        </h3>
        @if (!string.IsNullOrEmpty(user.AboutMe))
        {
            <div>@Formatter.Format(user.AboutMe)</div>
        }
        else
        {
            <p style="opacity: 0.6;">No information added yet.</p>
        }
    </div>

    <div style="background: @bgColor; border: 1px solid @borderColor; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
        <h3 style="color: @accentColor; margin-top: 0; display: inline-flex; align-items: center; gap: 0.4rem;">Vendor Profile
            @if (isAdminOrMod && !isSelf)
            {
                <details style="font-size: 0.85rem; color: #475569;">
                    <summary style="cursor: pointer; list-style: none;">‚úèÔ∏è</summary>
                    <form asp-action="AdminUpdateVendor" method="post" style="margin-top: 0.4rem; display: grid; gap: 0.35rem;">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <textarea name="vendorShopDescription" rows="2" placeholder="Shop" style="padding: 0.35rem; border: 1px solid @borderColor; border-radius: 6px; font-size: 0.9rem;">@user.VendorShopDescription</textarea>
                        <textarea name="vendorPolicies" rows="2" placeholder="Policies" style="padding: 0.35rem; border: 1px solid @borderColor; border-radius: 6px; font-size: 0.9rem;">@user.VendorPolicies</textarea>
                        <textarea name="vendorPayments" rows="2" placeholder="Payments" style="padding: 0.35rem; border: 1px solid @borderColor; border-radius: 6px; font-size: 0.9rem;">@user.VendorPayments</textarea>
                        <textarea name="vendorExternalReferences" rows="2" placeholder="External references" style="padding: 0.35rem; border: 1px solid @borderColor; border-radius: 6px; font-size: 0.9rem;">@user.VendorExternalReferences</textarea>
                        <button type="submit" class="button" style="width: fit-content; padding: 0.3rem 0.6rem; font-size: 0.85rem;">üíæ Save</button>
                    </form>
                </details>
            }
        </h3>
        <p class="meta" style="color: @fontColor; opacity: 0.7; margin-top: 0;">External references render as plain text; images and embeds are blocked.</p>
        @if (!string.IsNullOrWhiteSpace(user.VendorShopDescription) || !string.IsNullOrWhiteSpace(user.VendorPolicies) || !string.IsNullOrWhiteSpace(user.VendorPayments) || !string.IsNullOrWhiteSpace(user.VendorExternalReferences))
        {
            <div style="display: grid; gap: 0.8rem;">
                @if (!string.IsNullOrWhiteSpace(user.VendorShopDescription))
                {
                    <div>
                        <strong>Shop</strong>
                        <p style="margin: 0.25rem 0 0; white-space: pre-wrap;">@Html.Encode(user.VendorShopDescription)</p>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(user.VendorPolicies))
                {
                    <div>
                        <strong>Policies</strong>
                        <p style="margin: 0.25rem 0 0; white-space: pre-wrap;">@Html.Encode(user.VendorPolicies)</p>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(user.VendorPayments))
                {
                    <div>
                        <strong>Payments</strong>
                        <p style="margin: 0.25rem 0 0; white-space: pre-wrap;">@Html.Encode(user.VendorPayments)</p>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(user.VendorExternalReferences))
                {
                    <div>
                        <strong>External References</strong>
                        <p style="margin: 0.25rem 0 0; white-space: pre-wrap;">@Html.Encode(user.VendorExternalReferences)</p>
                    </div>
                }
            </div>
        }
        else
        {
            <p style="opacity: 0.6;">No vendor details added yet.</p>
        }
    </div>



    <div style="background: @bgColor; border: 1px solid @borderColor; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
        <h3 style="color: @accentColor; margin-top: 0;">Contact Info</h3>
        <ul>
            @foreach (var contact in user.Contacts)
            {
                <li>
                    <strong>@contact.ServiceName</strong>: @contact.AccountId
                    @if (isSelf)
                    {
                        <form asp-action="RemoveContact" method="post" style="display:inline">
                            <input type="hidden" name="id" value="@contact.Id" />
                            <button type="submit" class="btn-delete" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Remove</button>
                        </form>
                    }
                    else if (isAdminOrMod)
                    {
                        <form asp-action="AdminRemoveContact" method="post" style="display:inline">
                            <input type="hidden" name="id" value="@contact.Id" />
                            <button type="submit" class="btn-delete" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Remove</button>
                        </form>
                    }
                </li>
            }
        </ul>
    </div>

    <div style="background: @bgColor; border: 1px solid @borderColor; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; color: @fontColor;">
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <h3 style="margin: 0; color: @accentColor;">News Feed</h3>
        </div>
        @foreach (var news in user.News.OrderByDescending(n => n.CreatedAt))
        {
            var useTheme = news.ApplyTheme;
            var newsBg = useTheme ? bgColor : defaultRecentBg;
            var newsBorder = useTheme ? borderColor : defaultRecentBorder;
            var newsText = useTheme ? fontColor : defaultRecentText;
            var newsAccent = useTheme ? accentColor : defaultRecentAccent;

            <div style="border: 1px solid @newsBorder; background: @newsBg; color: @newsText; padding: 1rem 1rem 0.5rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                <h4 style="margin: 0 0 0.35rem 0; color: @newsAccent;"><a href="/user/news/@news.Id" style="color: @newsAccent; text-decoration: none;">@news.Title</a> <span class="meta" style="font-size: 0.8rem; color: @newsText; opacity: 0.7;">@news.CreatedAt.ToString("g")</span></h4>
                <div style="max-height: 200px; overflow: hidden; position: relative; color: @newsText;">
                    @Formatter.Format(news.Content)
                </div>
                <p style="margin: 0.4rem 0 0.6rem 0;"><a href="/user/news/@news.Id" style="font-size: 0.9rem; color: @newsAccent;">Read more / Permalink</a></p>
                @if (isSelf)
                {
                    <form asp-action="RemoveNews" method="post" style="display:inline">
                        <input type="hidden" name="id" value="@news.Id" />
                        <button type="submit" class="button" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Delete</button>
                    </form>
                }
                else if (isAdminOrMod)
                {
                    <form asp-action="AdminRemoveNews" method="post" style="display:inline">
                        <input type="hidden" name="id" value="@news.Id" />
                        <button type="submit" class="button" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; background: #dc2626; color: #fff; border-color: #dc2626;">Delete</button>
                    </form>
                }
            </div>
        }
    </div>

    <div style="background: @bgColor; border: 1px solid @borderColor; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
        <h3 style="color: @accentColor; margin-top: 0; display: inline-flex; align-items: center; gap: 0.35rem;">üîê PGP Public Key
            @if (isAdminOrMod && !isSelf && !string.IsNullOrWhiteSpace(user.PgpPublicKey))
            {
                <form asp-action="AdminClearPgpKey" method="post" style="display: inline;">
                    <input type="hidden" name="userId" value="@user.Id" />
                    <button type="submit" class="button" style="padding: 0.15rem 0.4rem; font-size: 0.8rem; background: #f97316; color: #fff; border-color: #f97316;">Clear</button>
                </form>
            }
        </h3>
        @if (!string.IsNullOrWhiteSpace(user.PgpPublicKey))
        {
            @if (user.PGPVerifications?.Any(v => v.Verified) == true)
            {
                <p style="color: #10b981; font-weight: 600; margin-bottom: 0.5rem;">‚úì Verified</p>
            }
            else
            {
                <p style="color: #f59e0b; font-weight: 600; margin-bottom: 0.5rem;">‚ö† Not Verified</p>
            }
            <pre style="white-space: pre-wrap; font-size: 0.7rem; max-height: 100px; overflow: auto; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid @borderColor; border-radius: 4px; color: @fontColor;">@user.PgpPublicKey</pre>
        }
        else
        {
            <p style="opacity: 0.6;">No PGP key configured</p>
        }
        
        @if (isSelf)
        {
            <div style="margin-top: 1rem;">
                <a href="/account/pgpsetup" class="button" style="background: @accentColor;">üîë Setup/Update PGP Key</a>
            </div>
        }
    </div>

    @if (isSelf)
    {
        <div style="background: @bgColor; border: 1px solid @borderColor; padding: 1.25rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div>
                <h3 style="margin: 0 0 0.35rem 0; color: @accentColor;">Reset your password</h3>
                <p style="margin: 0; opacity: 0.7; color: @fontColor;">You can change your password anytime without contacting support.</p>
            </div>
            <a href="/account/changepassword" class="button" style="background: @accentColor;">üîí Change Password</a>
        </div>
    }

    </div>
</div>
