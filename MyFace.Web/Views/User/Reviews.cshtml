@model MyFace.Web.Models.UserReviewsPageViewModel
@{
    var profileUser = Model.TargetUser;
    ViewData["Title"] = $"Reviews · {profileUser.Username}";
    var success = TempData["ReviewSuccess"] as string;
    var error = TempData["ReviewError"] as string;
    var viewerAuthenticated = User?.Identity?.IsAuthenticated ?? false;
}

<style>
    .reviews-shell {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.25rem 4rem;
    }
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .metric-card {
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 16px;
        padding: 1rem;
        background: rgba(15, 23, 42, 0.55);
        color: #e2e8f0;
    }
    .metric-card span {
        display: block;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.7);
    }
    .metric-card strong {
        font-size: 2rem;
        line-height: 1.2;
    }
    .reviews-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2.5rem;
    }
    .review-card {
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 18px;
        padding: 1.25rem;
        background: rgba(2, 6, 23, 0.7);
        color: #e2e8f0;
    }
    .review-card header {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .score-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: rgba(226, 232, 240, 0.85);
    }
    .review-form {
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 20px;
        padding: 1.5rem;
        background: rgba(15, 23, 42, 0.8);
        color: #e2e8f0;
    }
    .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .field-grid label,
    .review-form label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        display: block;
        margin-bottom: 0.2rem;
        color: rgba(226, 232, 240, 0.8);
    }
    .review-form input,
    .review-form textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(2, 6, 23, 0.6);
        color: #e2e8f0;
        padding: 0.6rem 0.8rem;
    }
    .review-form textarea {
        min-height: 140px;
        resize: vertical;
    }
    .cta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
    }
    .btn-primary {
        background: #38bdf8;
        color: #020617;
        border: none;
        border-radius: 999px;
        padding: 0.65rem 1.4rem;
        font-weight: 700;
        cursor: pointer;
    }
    .flash {
        border-radius: 16px;
        padding: 0.85rem 1rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    .flash.success { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .flash.error { background: rgba(248, 113, 113, 0.12); color: #fca5a5; }
</style>

<div class="reviews-shell">
    <h1 style="margin-bottom:0.25rem;">Reputation · @profileUser.Username</h1>
    <p style="margin-top:0; color:rgba(148,163,184,0.85);">What recent buyers are saying.</p>

    @if (!string.IsNullOrWhiteSpace(success))
    {
        <div class="flash success">@success</div>
    }
    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="flash error">@error</div>
    }

    <div class="metric-grid">
        <div class="metric-card">
            <span>Total reviews</span>
            <strong>@Model.Summary.TotalReviews</strong>
        </div>
        <div class="metric-card">
            <span>Average score</span>
            <strong>@Model.Summary.AverageScore.ToString("0.0")</strong>
        </div>
        <div class="metric-card">
            <span>Positive rate</span>
            <strong>@Model.Summary.PositivePercent.ToString("0.0")%</strong>
        </div>
    </div>

    <section class="reviews-list">
        @if (Model.Reviews.Count == 0)
        {
            <div class="review-card">
                <p style="margin:0;">No one has reviewed @profileUser.Username yet. Be the first buyer to vouch.</p>
            </div>
        }
        else
        {
            foreach (var review in Model.Reviews)
            {
                <article class="review-card">
                    <header>
                        <strong>@review.ReviewerUsername</strong>
                        <span style="font-size:0.85rem; color:rgba(226,232,240,0.7);">@review.CreatedAt.ToString("MMM d, yyyy")</span>
                    </header>
                    <div class="score-row">
                        <div>Comm: <strong>@review.CommunicationScore/5</strong></div>
                        <div>Shipping: <strong>@review.ShippingScore/5</strong></div>
                        <div>Quality: <strong>@review.QualityScore/5</strong></div>
                        <div>Overall: <strong>@review.OverallScore/5</strong></div>
                    </div>
                    <p style="margin:0; white-space:pre-wrap;">@review.Comment</p>
                    @if (review.IsViewer)
                    {
                        <small style="display:block; margin-top:0.5rem; color:#38bdf8;">This is your review.</small>
                    }
                </article>
            }
        }
    </section>

    <div class="cta-row" style="justify-content:space-between; align-items:center;">
        <div>
            <a href="@Url.Action("Index", "User", new { username = profileUser.Username })" style="color:#38bdf8; text-decoration:none;">← Back to profile</a>
        </div>
        <div style="color:rgba(148,163,184,0.85); font-size:0.9rem;">
            Page @Model.CurrentPage @((Model.HasMorePages || Model.CurrentPage > 1) ? $" · {(Model.HasMorePages ? "More available" : "End of feed")}" : string.Empty)
        </div>
    </div>

    @if (Model.CanSubmit)
    {
        <section class="review-form" style="margin-top:2rem;">
            <h2 style="margin-top:0;">Leave a review</h2>
            <form asp-action="SubmitReview" asp-route-username="@profileUser.Username" asp-route-page="@Model.CurrentPage" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="flash error" style="display:@(ViewData.ModelState.IsValid ? "none" : "block")"></div>
                <div class="field-grid">
                    <div>
                        <label for="communication">Communication</label>
                        <input id="communication" name="CommunicationScore" type="number" min="1" max="5" value="@Model.Form.CommunicationScore" />
                    </div>
                    <div>
                        <label for="shipping">Shipping</label>
                        <input id="shipping" name="ShippingScore" type="number" min="1" max="5" value="@Model.Form.ShippingScore" />
                    </div>
                    <div>
                        <label for="quality">Quality</label>
                        <input id="quality" name="QualityScore" type="number" min="1" max="5" value="@Model.Form.QualityScore" />
                    </div>
                    <div>
                        <label for="overall">Overall</label>
                        <input id="overall" name="OverallScore" type="number" min="1" max="5" value="@Model.Form.OverallScore" />
                    </div>
                </div>
                <label for="comment">Comment</label>
                <textarea id="comment" name="Comment">@Model.Form.Comment</textarea>
                <div class="cta-row">
                    <button class="btn-primary" type="submit">Save review</button>
                    @if (Model.HasExistingReview)
                    {
                        <span style="color:rgba(226,232,240,0.8);">Updating your previous review.</span>
                    }
                </div>
            </form>
        </section>
    }
    else if (!Model.ViewerIsOwner)
    {
        <p style="margin-top:2rem; color:rgba(148,163,184,0.85);">
            @if (!viewerAuthenticated)
            {
                <span><a href="/account/login" style="color:#38bdf8;">Sign in</a> to leave a review.</span>
            }
            else
            {
                <span>Only buyers other than @profileUser.Username can leave reviews.</span>
            }
        </p>
    }
</div>
