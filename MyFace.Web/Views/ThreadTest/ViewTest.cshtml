@using System.Collections.Generic
@using System.Linq
@using System.Security.Claims
@using MyFace.Core.Entities
@model MyFace.Core.Entities.Thread
@inject MyFace.Web.Services.BBCodeFormatter Formatter
@{
    ViewData["Title"] = $"{Model.Title} ¬∑ Test View";
    var postScores = (Dictionary<int, int>)ViewBag.PostScores;
    var currentUserId = (int?)ViewBag.CurrentUserId;
    var userRole = User.FindFirstValue(ClaimTypes.Role);
    var isAdmin = userRole == "Admin";
    var isMod = userRole == "Moderator";
    var isAdminOrMod = isAdmin || isMod;
    var reportThreshold = (int)(ViewBag.ReportHideThreshold ?? 2);
    var threadOwnerRole = Model.User?.Role ?? "User";
    var canEditThread = (currentUserId.HasValue && Model.UserId == currentUserId) || isAdmin || (isMod && threadOwnerRole == "User");
    var pageParam = ViewContext.HttpContext.Request.Query["page"].ToString();
    var currPage = int.TryParse(pageParam, out var p) && p > 0 ? p : 1;
    const int pageSize = 25;
    var ordered = Model.Posts.OrderBy(p => p.IsSticky ? 0 : 1).ThenBy(p => p.CreatedAt).ToList();
    var mainPost = ordered.FirstOrDefault();
    var visibleMainPost = mainPost;
    var replies = ordered.Skip(mainPost != null ? 1 : 0).ToList();
    if (!isAdminOrMod)
    {
        if (visibleMainPost != null && visibleMainPost.IsReportHidden)
        {
            visibleMainPost = null;
        }
        replies = replies.Where(p => !p.IsReportHidden).ToList();
    }
    var total = replies.Count;
    var skip = (currPage - 1) * pageSize;
    var pagePosts = replies.Skip(skip).Take(pageSize).ToList();
    var hasPrev = currPage > 1;
    var hasNext = skip + pagePosts.Count < total;
    var heroImages = visibleMainPost?.Images?.OrderBy(i => i.DisplayOrder).Take(2).ToList() ?? new List<PostImage>();
    var heroImageIds = heroImages.Select(i => i.Id).ToHashSet();
    var mainGalleryImages = (visibleMainPost?.Images ?? Enumerable.Empty<PostImage>())
        .OrderBy(i => i.DisplayOrder)
        .Where(i => !heroImageIds.Contains(i.Id))
        .ToList();
}
<div class="thread-test-return">
    <a href="@Url.Action("Index", "ThreadTest")" class="thread-action">‚Üê Back to test feed</a>
</div>
@if (visibleMainPost != null || (!isAdminOrMod && mainPost != null))
{
    <div class="card thread-shell thread-shell--test">
        <div class="thread-shell-header">
            <div class="thread-shell-title-row">
                <h1>@Model.Title</h1>
                <div class="thread-shell-badges">
                    @if (Model.IsLocked)
                    {
                        <span class="thread-badge locked">üîí LOCKED</span>
                    }
                    @if (!string.IsNullOrEmpty(Model.Category) && Model.Category != "Hot")
                    {
                        <span class="thread-badge category">@Model.Category</span>
                    }
                    <span class="thread-score">‚≠ê @ViewBag.ThreadScore</span>
                </div>
            </div>
            <div class="thread-shell-meta">
                <span class="meta">@Model.CreatedAt.ToString("u") by 
                    @if (Model.IsAnonymous)
                    {
                        <span>Anonymous</span>
                    }
                    else
                    {
                        @await Html.PartialAsync("_UserName", Model.User)
                    }
                </span>
            </div>
        </div>

        @if (heroImages.Any())
        {
            <div class="thread-hero-gallery" aria-label="Thread preview images">
                @foreach (var hero in heroImages)
                {
                    <a href="@hero.OriginalPath" target="_blank" rel="noopener" class="thread-hero-tile">
                        <img src="@hero.OriginalPath" alt="Preview image" loading="lazy" />
                    </a>
                }
            </div>
        }

        @if (visibleMainPost != null)
        {
            <div class="thread-shell-body">
                @Formatter.Format(visibleMainPost.Content)
            </div>
            @await Html.PartialAsync("_PostImageGallery", mainGalleryImages)
        }
        else
        {
            <div class="thread-shell-body" style="color: var(--text-muted);">
                This post is hidden pending moderation after multiple reports.
            </div>
        }

        <div class="thread-shell-actions">
            <div class="thread-shell-actions-primary">
                <form asp-controller="Vote" asp-action="ThreadUp" method="post">
                    <input type="hidden" name="threadId" value="@Model.Id" />
                    <button class="btn-vote btn-upvote" type="submit">üëç Thread</button>
                </form>
                <form asp-controller="Vote" asp-action="ThreadDown" method="post">
                    <input type="hidden" name="threadId" value="@Model.Id" />
                    <button class="btn-vote btn-downvote" type="submit">üëé Thread</button>
                </form>
                <a class="button button-secondary" href="#reply">Reply</a>
                @if (canEditThread)
                {
                    <a class="button" href="@Url.Action("Edit", "Thread", new { id = Model.Id })">‚úèÔ∏è Edit Thread</a>
                }
            </div>
            @if (isAdminOrMod)
            {
                <div class="thread-shell-actions-admin">
                    <form method="post" action="/thread/setcategory/@Model.Id" style="display: inline;">
                        <button type="submit" name="category" value="Hot" class="category-btn">üî• Hot</button>
                        @Html.AntiForgeryToken()
                    </form>
                    @if (userRole == "Moderator" || userRole == "Admin")
                    {
                        <form method="post" action="/thread/setcategory/@Model.Id" style="display: inline;">
                            <button type="submit" name="category" value="News" class="category-btn">üì∞ News</button>
                            @Html.AntiForgeryToken()
                        </form>
                    }
                    @if (userRole == "Admin")
                    {
                        <form method="post" action="/thread/setcategory/@Model.Id" style="display: inline;">
                            <button type="submit" name="category" value="Announcements" class="category-btn">üì¢ Announcements</button>
                            @Html.AntiForgeryToken()
                        </form>
                    }
                </div>
            }
        </div>
    </div>
}

@foreach (var post in pagePosts)
{
    var isOP = post.UserId == Model.UserId;
    <div class="post-card @(isOP ? "post-op" : string.Empty)" id="post-@post.Id">
        @if (post.IsSticky)
        {
            <div class="post-pinned">üìå Pinned Reply</div>
        }
        @if (isOP)
        {
            <div class="post-op-badge">üéØ Original Poster</div>
        }
        @if (post.IsReportHidden)
        {
            <div class="post-op-badge" style="background: #5a1f1f; color: #ffe3e3;">üö® Hidden after reports</div>
        }
        else if (post.ReportCount > 0)
        {
            <div class="post-op-badge" style="background: #444; color: #fff;">‚ö†Ô∏è Reported @post.ReportCount</div>
        }
        <div class="post-content">@Formatter.Format(post.Content)</div>
        @await Html.PartialAsync("_PostImageGallery", post.Images)
        <div class="post-footer">
            <div class="post-meta">
                <span class="meta">@post.CreatedAt.ToString("u") by 
                    @if (post.IsAnonymous)
                    {
                        <span>Anonymous</span>
                    }
                    else
                    {
                        @await Html.PartialAsync("_UserName", post.User)
                    }
                    @if (post.EditedAt.HasValue)
                    {
                        <span style="color: var(--text-muted); font-size: 0.9em;">
                            (modified @post.EditCount time@(post.EditCount != 1 ? "s" : "")
                            @if (post.EditedByUser != null)
                            {
                                <text> by </text>
                                @await Html.PartialAsync("_UserName", post.EditedByUser)
                            }
                            on @post.EditedAt.Value.ToString("u"))
                        </span>
                    }
                </span>
                <span class="post-score">‚≠ê @postScores[post.Id]</span>
                @if (post.IsReportHidden && isAdminOrMod)
                {
                    <span class="post-score" style="color: #ff8a65;">Hidden @post.ReportCount/@reportThreshold</span>
                }
            </div>
            <div class="post-actions">
                <form asp-controller="Vote" asp-action="Up" method="post">
                    <input type="hidden" name="postId" value="@post.Id" />
                    <button class="btn-vote btn-upvote" type="submit">üëç</button>
                </form>
                <form asp-controller="Vote" asp-action="Down" method="post">
                    <input type="hidden" name="postId" value="@post.Id" />
                    <button class="btn-vote btn-downvote" type="submit">üëé</button>
                </form>
                @{ var postOwnerRole = post.User?.Role ?? "User"; }
                @{ var canEditPost = !post.IsDeleted && ((currentUserId.HasValue && post.UserId == currentUserId) || isAdmin || (isMod && postOwnerRole == "User")); }
                @if (canEditPost)
                {
                    <a href="@Url.Action("Edit", "Post", new { id = post.Id })" class="btn-mod btn-edit">‚úèÔ∏è Edit</a>
                }
                @if (!post.IsDeleted && !post.IsReportHidden && currentUserId.HasValue)
                {
                    <form asp-controller="Post" asp-action="Report" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="postId" value="@post.Id" />
                        <button class="btn-mod" type="submit">üö© Report</button>
                    </form>
                }
                @if (isAdminOrMod)
                {
                    <form method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnToModeration" value="false" />
                        @if (post.IsReportHidden || post.ReportCount > 0)
                        {
                            <button formaction="@Url.Action("RestoreReportedPost", "Thread", new { postId = post.Id })" type="submit" class="btn-mod">‚úÖ Restore</button>
                        }
                        <button formaction="@Url.Action("AdminDeletePost", "Thread", new { postId = post.Id })" type="submit" class="btn-mod btn-delete">üóëÔ∏è</button>
                        @if (post.IsSticky)
                        {
                            <button formaction="@Url.Action("SetSticky", "Thread", new { postId = post.Id, isSticky = false })" type="submit" class="btn-mod">üìå</button>
                        }
                        else
                        {
                            <button formaction="@Url.Action("SetSticky", "Thread", new { postId = post.Id, isSticky = true })" type="submit" class="btn-mod">üìå</button>
                        }
                    </form>
                }
            </div>
        </div>
    </div>
}

<div class="pagination">
    @if (hasPrev)
    {
        <a class="btn-pagination" href="@Url.Action("ViewTest", new { id = Model.Id, page = currPage - 1 })">‚Üê Previous</a>
    }
    <span class="pagination-info">Page @currPage ¬∑ @pagePosts.Count of @total replies</span>
    @if (hasNext)
    {
        <a class="btn-pagination" href="@Url.Action("ViewTest", new { id = Model.Id, page = currPage + 1 })">Next ‚Üí</a>
    }
</div>

<div class="reply-section reply-section--test">
    <h2 id="reply">üí¨ Reply</h2>
    @if (Context.Request.Query["error"] == "CaptchaFailed")
    {
        <div class="error-message">Incorrect security check answer. Please try again.</div>
    }
    @if (TempData["ThreadTestReplyError"] is string replyError && !string.IsNullOrWhiteSpace(replyError))
    {
        <div class="error-message">@replyError</div>
    }
    <form asp-action="ReplyTest" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ThreadId" value="@Model.Id" />
        <label for="content">Content</label>
        <textarea id="content" name="Content" rows="6" class="input"></textarea>

        @await Html.PartialAsync("_BBCodeHelp")

        <label class="checkbox-label"><input type="checkbox" name="PostAsAnonymous" /> Post as Anonymous</label>

        <label for="ReplyImages">Attach up to two images</label>
        <div class="lux-upload compact" aria-describedby="reply-upload-help">
            <p class="lux-upload-copy">Select images directly; the browser will display their filenames once chosen.</p>
            <input id="ReplyImages" type="file" name="Images"
                   accept="image/png,image/jpeg,image/webp,image/gif"
                   multiple
                   class="lux-file-input"
                   aria-describedby="reply-upload-help" />
            <p id="reply-upload-help" class="lux-upload-hint">Only the first two files are persisted. Images larger than 6&nbsp;MB are rejected.</p>
        </div>

        <div class="captcha-box">
            <strong>@Html.Raw(ViewBag.CaptchaContext)</strong>
        </div>
        <details class="captcha-guide">
            <summary>How to complete this captcha</summary>
            <ul>
                <li>Read the phrase above.</li>
                <li>The question will ask for a word position or simple math.</li>
                <li>Case insensitive.</li>
            </ul>
        </details>
        <div class="form-group">
            <label for="captchaAnswer">@ViewBag.CaptchaQuestion</label>
            <input name="captchaAnswer" id="captchaAnswer" class="input" required autocomplete="off" />
        </div>

        <div class="form-actions">
            <button class="button button-primary" type="submit">Post Reply</button>
        </div>
    </form>
</div>


