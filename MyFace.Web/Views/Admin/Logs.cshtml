@using System.Collections.Generic
@using System.Linq
@using Microsoft.AspNetCore.WebUtilities
@model MyFace.Web.Models.Admin.AdminLogsPageViewModel
@{
    ViewData["Title"] = "Operations Logbook";
    var uploads = Model.Uploads;
    var filter = uploads.Filter ?? new MyFace.Web.Models.Admin.UploadLogFilterModel();
    var statusOptions = new[] { "", "Clean", "Malicious", "Skipped", "Error" };
    var originOptions = new[] { "", "ThreadCreate", "ThreadReply" };
    var totalPages = Math.Max(uploads.TotalPages, 1);
    var currentPage = Math.Clamp(uploads.Page, 1, totalPages);

    string BadgeClass(MyFace.Core.Entities.UploadScanLog entry) => entry.ScanStatus switch
    {
        "Malicious" => "badge-danger",
        "Error" => "badge-warning",
        "Skipped" => "badge-muted",
        _ => "badge-success"
    };
    string BlockBadge(bool blocked) => blocked ? "badge-danger" : "badge-success";

    string BuildPageUrl(int targetPage)
    {
        var baseUrl = Url.Action("Logs") ?? "/Admin/Logs";
        var query = new Dictionary<string, string?>
        {
            ["page"] = targetPage.ToString(),
            ["Filter.Status"] = filter.Status,
            ["Filter.Origin"] = filter.Origin,
            ["Filter.Blocked"] = filter.Blocked?.ToString()?.ToLowerInvariant(),
            ["Filter.Username"] = filter.Username,
            ["Filter.Threat"] = filter.Threat,
            ["Filter.SessionId"] = filter.SessionId,
            ["Filter.From"] = filter.From?.ToString("o"),
            ["Filter.To"] = filter.To?.ToString("o")
        };

        var sanitized = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase);
        foreach (var kvp in query)
        {
            if (!string.IsNullOrWhiteSpace(kvp.Value))
            {
                sanitized[kvp.Key] = kvp.Value;
            }
        }

        return QueryHelpers.AddQueryString(baseUrl, sanitized);
    }
}

@section HeadExtras {
    <meta http-equiv="refresh" content="@Model.AutoRefreshSeconds" />
}

<div class="log-head">
    <div>
        <h1 class="admin-title">Operations Logbook</h1>
        <p class="log-meta">Updated @Model.GeneratedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") • Auto refresh every @Model.AutoRefreshSeconds seconds</p>
    </div>
    <div class="log-head__actions">
        <a class="btn" asp-action="Index">⟵ Back to Admin</a>
        <span class="log-head__count">@uploads.TotalCount entries</span>
    </div>
</div>

<div class="log-grid">
    <section class="log-panel log-panel--wide">
        <header class="log-panel__heading">
            <div>
                <p class="log-panel__title">Upload Security Log</p>
                <p class="log-panel__subtitle">Images scanned • Page @currentPage of @totalPages</p>
            </div>
            <div class="log-panel__stats">
                <span>Showing @ViewBag.PageSize per page</span>
            </div>
        </header>
        <form method="get" class="filter-grid log-filter">
            <div>
                <label>Status</label>
                <select name="Filter.Status" class="input">
                    @foreach (var status in statusOptions)
                    {
                        var label = string.IsNullOrEmpty(status) ? "Any" : status;
                        <option value="@status" selected="@((filter.Status == status) ? "selected" : null)">@label</option>
                    }
                </select>
            </div>
            <div>
                <label>Origin</label>
                <select name="Filter.Origin" class="input">
                    @foreach (var origin in originOptions)
                    {
                        var label = string.IsNullOrEmpty(origin) ? "Any" : origin;
                        <option value="@origin" selected="@((filter.Origin == origin) ? "selected" : null)">@label</option>
                    }
                </select>
            </div>
            <div>
                <label>Blocked?</label>
                <select name="Filter.Blocked" class="input">
                    <option value="" selected="@((filter.Blocked == null) ? "selected" : null)">Any</option>
                    <option value="true" selected="@((filter.Blocked == true) ? "selected" : null)">Yes</option>
                    <option value="false" selected="@((filter.Blocked == false) ? "selected" : null)">No</option>
                </select>
            </div>
            <div>
                <label>User</label>
                <input type="text" name="Filter.Username" value="@filter.Username" class="input" placeholder="username" />
            </div>
            <div>
                <label>Threat</label>
                <input type="text" name="Filter.Threat" value="@filter.Threat" class="input" placeholder="signature" />
            </div>
            <div>
                <label>Session ID</label>
                <input type="text" name="Filter.SessionId" value="@filter.SessionId" class="input" />
            </div>
            <div>
                <label>From (UTC)</label>
                <input type="datetime-local" name="Filter.From" value="@(filter.From?.ToString("yyyy-MM-ddTHH:mm"))" class="input" />
            </div>
            <div>
                <label>To (UTC)</label>
                <input type="datetime-local" name="Filter.To" value="@(filter.To?.ToString("yyyy-MM-ddTHH:mm"))" class="input" />
            </div>
            <div class="log-filter__actions">
                <button type="submit" class="btn btn-info">Apply Filters</button>
                <a class="btn btn-muted" asp-action="Logs">Reset</a>
            </div>
        </form>

        @if (!uploads.Entries.Any())
        {
            <div class="alert-info log-empty">No log entries found.</div>
        }
        else
        {
            <div class="table-responsive log-table">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp (UTC)</th>
                            <th>Origin</th>
                            <th>User</th>
                            <th>Scan Result</th>
                            <th>File</th>
                            <th>Processing</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var entry in uploads.Entries)
                    {
                        <tr>
                            <td>
                                <div>@entry.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</div>
                                <div class="text-muted">Session: @entry.SessionId</div>
                            </td>
                            <td>
                                <div><strong>@entry.Source</strong></div>
                                <div class="text-muted">@entry.EventType</div>
                            </td>
                            <td>
                                @if (entry.UserId.HasValue)
                                {
                                    <div><strong>@entry.UsernameSnapshot</strong> (#@entry.UserId)</div>
                                }
                                else
                                {
                                    <div><strong>Anonymous</strong></div>
                                }
                                <div class="text-muted">@((entry.IsAnonymous ? "Hidden" : "Visible"))</div>
                            </td>
                            <td>
                                <div><span class="badge @BadgeClass(entry)">@entry.ScanStatus</span></div>
                                @if (!string.IsNullOrWhiteSpace(entry.ThreatName))
                                {
                                    <div class="text-danger">@entry.ThreatName</div>
                                }
                                <div class="text-muted">@entry.ScanEngine</div>
                                <div class="text-muted">@entry.ScannerMessage</div>
                                <div><span class="badge @BlockBadge(entry.Blocked)">@((entry.Blocked ? "Blocked" : "Allowed"))</span></div>
                            </td>
                            <td>
                                <div>@entry.OriginalFileName</div>
                                <div class="text-muted">@entry.ContentType</div>
                                <div class="text-muted">@entry.Width x @entry.Height px</div>
                                <div class="text-muted">@String.Format("{0:0.##} MB", entry.FileSize / 1024f / 1024f)</div>
                                @if (!string.IsNullOrWhiteSpace(entry.StoragePath))
                                {
                                    <div><a href="@entry.StoragePath" target="_blank">open</a></div>
                                }
                            </td>
                            <td>
                                <div class="text-muted">Scan: @entry.ScanDurationMs ms</div>
                                <div class="text-muted">Total: @entry.ProcessingDurationMs ms</div>
                                @if (!string.IsNullOrWhiteSpace(entry.FailureReason))
                                {
                                    <div class="text-danger">@entry.FailureReason</div>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>

            <div class="pagination log-pagination">
                <div>Page @currentPage of @totalPages</div>
                <div class="log-pagination__actions">
                    @if (currentPage > 1)
                    {
                        <a class="btn btn-muted" href="@BuildPageUrl(currentPage - 1)">Prev</a>
                    }
                    @if (currentPage < totalPages)
                    {
                        <a class="btn btn-muted" href="@BuildPageUrl(currentPage + 1)">Next</a>
                    }
                </div>
            </div>
        }
    </section>

    <section class="log-panel log-panel--wide">
        <header class="log-panel__heading">
            <div>
                <p class="log-panel__title">Post Log</p>
                <p class="log-panel__subtitle">Latest @Model.PostLog.Count posts</p>
            </div>
        </header>
        @if (!Model.PostLog.Any())
        {
            <div class="log-empty">No recent posts.</div>
        }
        else
        {
            <div class="log-stream log-stream--dense">
                @foreach (var entry in Model.PostLog)
                {
                    var rowClass = entry.IsDeleted || entry.WasModerated ? " log-row--alert" : string.Empty;
                    <div class="log-row@rowClass">
                        <div class="log-row__line">
                            <span class="log-time">@entry.CreatedAtUtc.ToLocalTime().ToString("HH:mm:ss")</span>
                            <span class="log-actor">@entry.ActorLabel</span>
                            <span class="log-tag" title="@entry.ThreadTitle">@entry.ThreadTitle</span>
                        </div>
                        <div class="log-row__line log-row__line--muted">
                            <span class="log-snippet">@entry.Snippet</span>
                            <span class="log-meta">
                                @if (entry.ImageCount > 0)
                                {
                                    <span>@entry.ImageCount img</span>
                                }
                                <span>Reports: @entry.ReportCount</span>
                                @if (entry.IsDeleted)
                                {
                                    <span class="log-flag">Deleted</span>
                                }
                                else if (entry.WasModerated)
                                {
                                    <span class="log-flag">Moderated</span>
                                }
                            </span>
                        </div>
                    </div>
                }
            </div>
        }
    </section>

    <section class="log-panel log-panel--wide">
        <header class="log-panel__heading">
            <div>
                <p class="log-panel__title">Traffic Logbook</p>
                <p class="log-panel__subtitle">Page loads & link clicks (recent)</p>
            </div>
        </header>
        @if (!Model.VisitLog.Any())
        {
            <div class="log-empty">No recent traffic.</div>
        }
        else
        {
            <div class="log-stream log-stream--mono">
                @foreach (var entry in Model.VisitLog)
                {
                    var rowClass = entry.IsRecent ? " log-row--recent" : string.Empty;
                    <div class="log-row@rowClass">
                        <div class="log-row__line">
                            <span class="log-time">@entry.VisitedAtUtc.ToLocalTime().ToString("HH:mm:ss")</span>
                            <span class="log-actor">@entry.ActorLabel</span>
                            <span class="log-tag">@entry.EventLabel</span>
                        </div>
                        <div class="log-row__line log-row__line--muted">
                            <span class="log-path" title="@entry.Path">@entry.Path</span>
                            <span class="log-meta">@entry.SessionLabel</span>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>
