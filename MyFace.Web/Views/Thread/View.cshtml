@model MyFace.Core.Entities.Thread
@{
    ViewData["Title"] = Model.Title;
    var postScores = (Dictionary<int, int>)ViewBag.PostScores;
    // Simple server-side pagination inside the view
    var pageParam = ViewContext.HttpContext.Request.Query["page"].ToString();
    var currPage = int.TryParse(pageParam, out var p) && p > 0 ? p : 1;
    const int pageSize = 25;
    var ordered = Model.Posts.OrderBy(p => p.CreatedAt).ToList();
    var total = ordered.Count;
    var skip = (currPage - 1) * pageSize;
    var pagePosts = ordered.Skip(skip).Take(pageSize).ToList();
    var hasPrev = currPage > 1;
    var hasNext = skip + pagePosts.Count < total;
}
<h1>@Model.Title</h1>
<p class="meta">Started @Model.CreatedAt.ToString("u") by @(Model.IsAnonymous ? "Anonymous" : Model.User?.Username ?? "Anonymous")</p>

@foreach (var post in pagePosts)
{
    <div class="card" id="post-@post.Id">
        <p>@post.Content</p>
        <p class="meta">@post.CreatedAt.ToString("u") by @(post.IsAnonymous ? "Anonymous" : post.User?.Username ?? "Anonymous")</p>
        <p class="score">Score: @postScores[post.Id]</p>
        <form asp-controller="Vote" asp-action="Up" method="post" style="display:inline">
            <input type="hidden" name="postId" value="@post.Id" />
            <button class="button" type="submit">Upvote</button>
        </form>
        <form asp-controller="Vote" asp-action="Down" method="post" style="display:inline">
            <input type="hidden" name="postId" value="@post.Id" />
            <button class="button" type="submit">Downvote</button>
        </form>
    </div>
}

<div class="form-actions">
    @if (hasPrev)
    {
        <a class="button" href="@Url.Action("View", new { id = Model.Id, page = currPage - 1 })">Previous</a>
    }
    @if (hasNext)
    {
        <a class="button" href="@Url.Action("View", new { id = Model.Id, page = currPage + 1 })">Next</a>
    }
    <span class="meta"> Page @currPage </span>
    <span class="meta"> Showing @pagePosts.Count of @total posts </span>
}</div>

<h2 id="reply">Reply</h2>
<form asp-action="Reply" method="post">
    <input type="hidden" name="threadId" value="@Model.Id" />
    <label for="content">Content</label>
    <textarea id="content" name="content" rows="6"></textarea>
    <label><input type="checkbox" name="postAsAnonymous" /> Post as Anonymous</label>
    <div class="form-actions">
        <button class="button" type="submit">Reply</button>
    </div>
</form>
