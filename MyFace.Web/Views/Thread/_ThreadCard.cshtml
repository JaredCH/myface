@model MyFace.Core.Entities.Thread
@inject MyFace.Web.Services.BBCodeFormatter Formatter
@using System.Security.Claims
@using System.Linq
@using MyFace.Core.Entities
@{
    var userRole = User.FindFirstValue(ClaimTypes.Role);
    var isAdminOrMod = userRole == "Admin" || userRole == "Moderator";
    var firstPost = Model.Posts.OrderBy(p => p.CreatedAt).FirstOrDefault();
    var gallerySource = Model.Posts
        .OrderBy(p => p.CreatedAt)
        .FirstOrDefault(p => p.Images != null && p.Images.Any());
    var galleryImages = (gallerySource?.Images ?? Enumerable.Empty<PostImage>())
        .OrderBy(i => i.DisplayOrder)
        .ThenBy(i => i.Id)
        .Take(3)
        .ToList();
}
<div class="card thread-card">
    <h2 class="thread-title"><a href="@Url.Action("View", new { id = Model.Id })">@Model.Title</a></h2>
    <p class="meta">Started @Model.CreatedAt.ToString("u") by 
        @if (Model.IsAnonymous)
        {
            <span>Anonymous</span>
        }
        else
        {
            @await Html.PartialAsync("_UserName", Model.User)
        }
    </p>
    <div class="preview clamp-5">@Formatter.Format(firstPost?.Content ?? "")</div>
    @if (galleryImages.Any())
    {
        <div class="thread-card-gallery" aria-label="Thread preview images">
            @foreach (var image in galleryImages)
            {
                var thumb = string.IsNullOrWhiteSpace(image.ThumbnailPath) ? image.OriginalPath : image.ThumbnailPath;
                <a href="@image.OriginalPath" target="_blank" rel="noopener" class="thread-card-thumb">
                    <img src="@thumb" alt="Thread attachment preview" loading="lazy" />
                </a>
            }
        </div>
    }
    <div class="card-footer">
        <a class="button" href="@Url.Action("View", new { id = Model.Id })">View Thread</a>
        <span class="meta">@Model.Posts.Count post(s)</span>
        @if (Model.IsLocked)
        {
            <span class="status-badge" style="margin-left: 0.5rem;">ğŸ”’ Locked</span>
        }
        @if (isAdminOrMod)
        {
            <form method="post" style="display: inline; margin-left: 1rem;">
                @if (Model.IsLocked)
                {
                    <button formaction="@Url.Action("UnlockThread", new { id = Model.Id })" type="submit" class="button" style="padding: 0.2rem 0.4rem; font-size: 0.8rem;">ğŸ”“ Unlock</button>
                }
                else
                {
                    <button formaction="@Url.Action("LockThread", new { id = Model.Id })" type="submit" class="button" style="padding: 0.2rem 0.4rem; font-size: 0.8rem;">ğŸ”’ Lock</button>
                }
                <button formaction="@Url.Action("DeleteThread", new { id = Model.Id })" type="submit" class="button" style="padding: 0.2rem 0.4rem; font-size: 0.8rem; background: #c0392b;">ğŸ—‘ï¸ Delete</button>
            </form>
        }
    </div>
</div>
