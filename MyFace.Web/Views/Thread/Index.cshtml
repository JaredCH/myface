@model List<MyFace.Core.Entities.Thread>
@inject MyFace.Web.Services.BBCodeFormatter Formatter
@using System.Security.Claims
@{
    ViewData["Title"] = "Threads";
    var userRole = User.FindFirstValue(ClaimTypes.Role);
    var isAdminOrMod = userRole == "Admin" || userRole == "Moderator";
}
<h1>Threads</h1>
<p><a href="@Url.Action("Create")" class="button">New Thread</a> | <a href="@Url.Action("Threads","Rss")">RSS</a></p>

@foreach (var thread in Model)
{
    var firstPost = thread.Posts
        .OrderBy(p => p.CreatedAt)
        .FirstOrDefault();
    <div class="card thread-card">
        <h2 class="thread-title"><a href="@Url.Action("View", new { id = thread.Id })">@thread.Title</a></h2>
        <p class="meta">Started @thread.CreatedAt.ToString("u") by 
            @if (thread.IsAnonymous)
            {
                <span>Anonymous</span>
            }
            else
            {
                <a href="/user/@(thread.User?.Username ?? "Anonymous")">@(thread.User?.Username ?? "Anonymous")</a>
            }
        </p>
        <div class="preview clamp-5">@Formatter.Format(firstPost?.Content ?? "")</div>
        <div class="card-footer">
            <a class="button" href="@Url.Action("View", new { id = thread.Id })">View Thread</a>
            <span class="meta">@thread.Posts.Count post(s)</span>
            @if (thread.IsLocked)
            {
                <span class="status-badge" style="margin-left: 0.5rem;">ğŸ”’ Locked</span>
            }
            @if (isAdminOrMod)
            {
                <form method="post" style="display: inline; margin-left: 1rem;">
                    @if (thread.IsLocked)
                    {
                        <button formaction="@Url.Action("UnlockThread", new { id = thread.Id })" type="submit" class="button" style="padding: 0.2rem 0.4rem; font-size: 0.8rem;">ğŸ”“ Unlock</button>
                    }
                    else
                    {
                        <button formaction="@Url.Action("LockThread", new { id = thread.Id })" type="submit" class="button" style="padding: 0.2rem 0.4rem; font-size: 0.8rem;">ğŸ”’ Lock</button>
                    }
                    <button formaction="@Url.Action("DeleteThread", new { id = thread.Id })" type="submit" class="button" style="padding: 0.2rem 0.4rem; font-size: 0.8rem; background: #c0392b;" onclick="return confirm('Delete this thread and all replies?');">ğŸ—‘ï¸ Delete</button>
                </form>
            }
        </div>
    </div>
}

<div class="form-actions">
    @if ((int)ViewBag.CurrentPage > 1)
    {
        <a class="button" href="@Url.Action("Index", new { page = (int)ViewBag.CurrentPage - 1 })">Previous</a>
    }
    @if ((bool)ViewBag.HasMorePages)
    {
        <a class="button" href="@Url.Action("Index", new { page = (int)ViewBag.CurrentPage + 1 })">Next</a>
    }
    <span class="meta"> Page @((int)ViewBag.CurrentPage) </span>
</div>
