@{
    ViewData["Title"] = "PGP Key Setup";
    var step = ViewBag.Step?.ToString() ?? "1";
    var challenge = ViewBag.Challenge as string;
    var fingerprint = ViewBag.Fingerprint as string;
    var currentKey = ViewBag.CurrentKey as string;
    var error = ViewBag.Error as string;
    var message = ViewBag.Message as string;

    var step1State = step == "1" ? "active" : (step == "2" || step == "3" ? "complete" : string.Empty);
    var step2State = step == "2" ? "active" : (step == "3" ? "complete" : string.Empty);
    var step3State = step == "3" ? "active" : string.Empty;
}

<div class="pgp-setup">
    <div class="pgp-hero">
        <h1>üîê PGP Key Setup</h1>
        <p class="meta">Verify ownership of your PGP key to enable secure communication</p>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert-error">
            <strong>Error:</strong> @error
        </div>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert-success">
            <strong>Success:</strong> @message
        </div>
    }

    <div class="pgp-progress">
        <div class="pgp-progress-item @step1State">
            <div class="pgp-progress-badge">1</div>
            <p class="pgp-progress-label">Paste Key</p>
            <div class="pgp-progress-connector"></div>
        </div>
        <div class="pgp-progress-item @step2State">
            <div class="pgp-progress-badge">2</div>
            <p class="pgp-progress-label">Sign Challenge</p>
            <div class="pgp-progress-connector"></div>
        </div>
        <div class="pgp-progress-item @step3State">
            <div class="pgp-progress-badge">3</div>
            <p class="pgp-progress-label">Verify</p>
        </div>
    </div>

    @if (step == "1")
    {
        <div class="card pgp-card">
            <h2 style="margin-top: 0;">Step 1: Paste Your PGP Public Key</h2>
            <p class="meta">Provide your ASCII-armored PGP public key. The fingerprint will be automatically extracted.</p>
            
            <form asp-action="PgpSetupStep1" method="post">
                <label for="PgpPublicKey" style="font-weight: 600; display: block; margin-bottom: 0.5rem;">PGP Public Key (ASCII-armored)</label>
                <textarea id="PgpPublicKey" name="PgpPublicKey" rows="12" class="input monospace" placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----&#10;&#10;...&#10;&#10;-----END PGP PUBLIC KEY BLOCK-----">@currentKey</textarea>
                
                <div class="pgp-actions">
                    <button type="submit" class="button button-primary">Next: Generate Challenge ‚Üí</button>
                    <a href="/user/@ViewBag.Username" class="button button-secondary button-narrow">Cancel</a>
                </div>
            </form>
        </div>
    }
    else if (step == "2")
    {
        <div class="card pgp-card">
            <h2 style="margin-top: 0;">Step 2: Sign the Challenge</h2>
            <p class="meta">Copy the challenge text below, sign it with your PGP key, and paste the signature.</p>
            
            <div class="card pgp-challenge-card" style="margin: 1.25rem 0;">
                <label>Challenge Text (select all to copy):</label>
                <textarea readonly onfocus="this.select()" class="pgp-challenge monospace" rows="3">@challenge</textarea>
                <p class="pgp-helper">üí° Click in the box above to auto-select all text, then copy (Ctrl+C / Cmd+C)</p>
            </div>

            <div class="pgp-guide">
                <p style="margin: 0;"><strong>How to sign:</strong></p>
                <p style="margin: 0.5rem 0 0 0;">Save the challenge text to a file, then run:<br><code>gpg --armor --detach-sign challenge.txt</code></p>
            </div>

            <form asp-action="PgpSetupStep2" method="post">
                <input type="hidden" name="Fingerprint" value="@fingerprint" />
                <label for="Response" style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Paste Your Signature (ASCII-armored)</label>
                <textarea id="Response" name="Response" rows="10" class="input monospace" placeholder="-----BEGIN PGP SIGNATURE-----&#10;&#10;...&#10;&#10;-----END PGP SIGNATURE-----"></textarea>
                
                <div class="pgp-actions">
                    <button type="submit" class="button button-success">Verify Signature ‚úì</button>
                    <a href="/account/pgpsetup" class="button button-secondary button-narrow">Back</a>
                </div>
            </form>
        </div>
    }
    else if (step == "3")
    {
        <div class="card pgp-card" style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
            <h2 style="margin-top: 0; color: #10b981;">PGP Key Verified Successfully!</h2>
            <p class="meta">Your PGP public key has been verified and is now active on your profile.</p>
            
            @if (!string.IsNullOrEmpty(fingerprint))
            {
                <div class="pgp-fingerprint">
                    <p class="label">Verified Fingerprint:</p>
                    <p class="value">@fingerprint</p>
                </div>
            }
            
            <div style="margin-top: 2rem;">
                <a href="/user/@ViewBag.Username" class="button button-primary">Return to Profile</a>
            </div>
        </div>
    }
</div>
