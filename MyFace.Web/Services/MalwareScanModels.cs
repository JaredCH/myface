using System;
using System.Diagnostics;
using System.IO;
using System.Threading;
using System.Threading.Tasks;

namespace MyFace.Web.Services;

public interface IMalwareScanner
{
    Task<MalwareScanResult> ScanAsync(Stream stream, string fileName, CancellationToken cancellationToken = default);
}

public enum MalwareScanStatus
{
    Clean,
    Malicious,
    Skipped,
    Error
}

public sealed record MalwareScanResult(
    MalwareScanStatus Status,
    string Engine,
    string Message,
    string? ThreatName,
    TimeSpan Duration,
    bool ScannerAvailable)
{
    public bool ShouldBlock(bool blockOnError)
    {
        return Status switch
        {
            MalwareScanStatus.Malicious => true,
            MalwareScanStatus.Error => blockOnError,
            _ => false
        };
    }

    public static MalwareScanResult Clean(string engine, string message, TimeSpan duration) =>
        new(MalwareScanStatus.Clean, engine, message, null, duration, true);

    public static MalwareScanResult Malicious(string engine, string message, string threatName, TimeSpan duration) =>
        new(MalwareScanStatus.Malicious, engine, message, threatName, duration, true);

    public static MalwareScanResult Error(string engine, string message, TimeSpan duration, bool scannerAvailable) =>
        new(MalwareScanStatus.Error, engine, message, null, duration, scannerAvailable);

    public static MalwareScanResult Skipped(string engine, string message, TimeSpan duration, bool scannerAvailable) =>
        new(MalwareScanStatus.Skipped, engine, message, null, duration, scannerAvailable);
}

public class MalwareScannerOptions
{
    public bool Enabled { get; set; } = false;
    public string EngineName { get; set; } = "ClamAV";
    public string Command { get; set; } = "/usr/bin/clamscan";
    public string Arguments { get; set; } = "--no-summary --infected";
    public int TimeoutSeconds { get; set; } = 30;
    public string WorkingDirectory { get; set; } = "/tmp";
    public bool BlockOnError { get; set; } = false;
    public bool FailOpenWhenUnavailable { get; set; } = true;
}
